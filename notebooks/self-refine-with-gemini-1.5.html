<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.41">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-07-06">

<title>Limin's Machine Learning Lab – Self-refine with Gemini 1.5</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Limin’s Machine Learning Lab</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/liminma/machine-learning-lab"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/liminma2021"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Self-refine with Gemini 1.5</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Agentic Patterns</div>
                <div class="quarto-category">Reflection</div>
                <div class="quarto-category">Prompt Engineering</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 6, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prepare-3-prompt-templates" id="toc-prepare-3-prompt-templates" class="nav-link active" data-scroll-target="#prepare-3-prompt-templates">Prepare 3 prompt templates</a>
  <ul class="collapse">
  <li><a href="#init-prompt-template" id="toc-init-prompt-template" class="nav-link" data-scroll-target="#init-prompt-template">1. init prompt template</a></li>
  <li><a href="#feedback-prompt-template" id="toc-feedback-prompt-template" class="nav-link" data-scroll-target="#feedback-prompt-template">2. feedback prompt template</a></li>
  <li><a href="#refine-prompt-template" id="toc-refine-prompt-template" class="nav-link" data-scroll-target="#refine-prompt-template">3. refine prompt template</a></li>
  </ul></li>
  <li><a href="#experiments" id="toc-experiments" class="nav-link" data-scroll-target="#experiments">Experiments</a>
  <ul class="collapse">
  <li><a href="#configure-both-gemini-1.5-flash-and-gemini-1.5-pro-models." id="toc-configure-both-gemini-1.5-flash-and-gemini-1.5-pro-models." class="nav-link" data-scroll-target="#configure-both-gemini-1.5-flash-and-gemini-1.5-pro-models.">Configure both <code>gemini-1.5-flash</code> and <code>gemini-1.5-pro</code> models.</a></li>
  <li><a href="#exp-01-using-gemini-1.5-flash" id="toc-exp-01-using-gemini-1.5-flash" class="nav-link" data-scroll-target="#exp-01-using-gemini-1.5-flash">Exp 01: using <code>gemini-1.5-flash</code></a>
  <ul class="collapse">
  <li><a href="#generate-the-initital-sentence" id="toc-generate-the-initital-sentence" class="nav-link" data-scroll-target="#generate-the-initital-sentence">1. generate the initital sentence</a></li>
  <li><a href="#run-the-refine-loop" id="toc-run-the-refine-loop" class="nav-link" data-scroll-target="#run-the-refine-loop">2. run the refine loop</a></li>
  </ul></li>
  <li><a href="#exp-02-using-gemini-1.5-pro" id="toc-exp-02-using-gemini-1.5-pro" class="nav-link" data-scroll-target="#exp-02-using-gemini-1.5-pro">Exp 02: using <code>gemini-1.5-pro</code></a>
  <ul class="collapse">
  <li><a href="#generate-the-initital-sentence-1" id="toc-generate-the-initital-sentence-1" class="nav-link" data-scroll-target="#generate-the-initital-sentence-1">1. generate the initital sentence</a></li>
  <li><a href="#run-the-refine-loop-1" id="toc-run-the-refine-loop-1" class="nav-link" data-scroll-target="#run-the-refine-loop-1">2. run the refine loop</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p style="text-align:center;">
<img class="preview-image" src="self-refine-with-gemini-1.5_files/figure-html/feaafcdf-7ee8-449c-b975-43e7d0bf18bd-1-025f9a30-4afd-4412-9268-6052e78c6ac8.png" width="800px"><br> Source: Madaan et al. <span class="citation" data-cites="madaan2023selfrefine">[<a href="#ref-madaan2023selfrefine" role="doc-biblioref">1</a>]</span>
</p>
<p>Self-refine <span class="citation" data-cites="madaan2023selfrefine">[<a href="#ref-madaan2023selfrefine" role="doc-biblioref">1</a>]</span> is an approach that iteratively improves a model’s output based on its own feedback. It is suitable for stronger models. Given an initial output, it consists of 2 main steps: feedback and refine. The feedback contains concrete actions that can improve the output and identifies specific phrases in the output to be improved. Good feedback is cruicial for the approach to work.</p>
<p>Self-refine uses three prompts: initial generation, feedback and refinement. The authors used few-shot prompting as in-context learning to guide the model:</p>
<ul>
<li>Initial generation prompt: few-shot prompt plus input</li>
<li>feedback prompt: few-shot prompt plus input and current output (initial output or the latest refined output)</li>
<li>refine prompt: few-shot prompt plus input and the history of refinement.
<ul>
<li>examples in the few-shot prompt also include refinement history</li>
</ul></li>
</ul>
<p>This notebook experiments with self-refine for constrained generation using Gemini 1.5 models.</p>
<div id="b87c4db1-fa24-4550-8f3a-d65c32bc5e44" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Import necessary libraries</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nltk</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> google.generativeai <span class="im">as</span> genai</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.ai.generativelanguage <span class="im">import</span> Part, Content</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.request <span class="im">import</span> urlopen</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">'../src'</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> utils</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>load_dotenv()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="prepare-3-prompt-templates" class="level1">
<h1>Prepare 3 prompt templates</h1>
<p>All three prompt templates are constructed using data from authors’ repo at <a href="https://github.com/madaan/self-refine">madaan/self-refine</a>.</p>
<section id="init-prompt-template" class="level2">
<h2 class="anchored" data-anchor-id="init-prompt-template">1. init prompt template</h2>
<div id="5d7b65e9-f3b1-4f31-85dd-4823e477f10f" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the help functions</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_examples(file_url):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> urlopen(file_url) <span class="im">as</span> f:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        lines <span class="op">=</span> f.readlines()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> x: json.loads(x), lines))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> examples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="6532a277-3ceb-4836-8e29-8f35ad9667b8" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_init_prompt_template():</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    examples_url<span class="op">=</span><span class="st">'https://raw.githubusercontent.com/madaan/self-refine/main/data/prompt/commongen/init.jsonl'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> download_examples(examples_url)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    prompt_head <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">I want you to create a sentence that contains all the specified concepts.</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some examples:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    prompt_end <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="st">Now create a sentence using the following concepts:</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="st">Concepts: </span><span class="sc">{concepts}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="st">The sentence is:</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    example_template <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="st">Concepts: </span><span class="sc">{concepts}</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="st">The sentence is: </span><span class="sc">{sentence}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    examples_prompt <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        examples_prompt <span class="op">+=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> example_template.<span class="bu">format</span>(</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            concepts<span class="op">=</span>example[<span class="st">'concepts'</span>],</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            sentence<span class="op">=</span>example[<span class="st">'target'</span>]</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    prompt_template <span class="op">=</span> prompt_head <span class="op">+</span> examples_prompt <span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> prompt_end</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prompt_template</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1e3fb1cd-ed60-46d9-a61a-8c7f4b543f4c" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>init_prompt_template <span class="op">=</span> construct_init_prompt_template()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>utils.display_html(init_prompt_template, <span class="st">'Show init prompt template'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<details><summary>Show init prompt template</summary><pre>I want you to create a sentence that contains all the specified concepts.

Here are some examples:

Concepts: ['footage', 'motion', 'ruin', 'tilt', 'window']
The sentence is: time lapse footage with tilt up motion of the sun streaking through window of ruin

Concepts: ['cause', 'hate', 'hut', 'local', 'love']
The sentence is: new beach huts on the island have caused some controversy some locals love them others hate them

Concepts: ['call', 'contain', 'dress', 'gown', 'wallpaper']
The sentence is: the wallpaper probably containing a gown and a dinner dress called

Concepts: ['knock', 'leave', 'pew', 'rush', 'seat']
The sentence is: She leaves the confessional and rushes past a pew, knocking a Bible from the seat.

Concepts: ['help', 'moment', 'spend', 'uplift', 'world']
The sentence is: every moment that we spend in higher consciousness helps uplift the consciousness of the whole world

Concepts: ['label', 'pende', 'stamp', 'text', 'write']
The sentence is: abstract stamp or label with the text pending written inside

Concepts: ['create', 'ferry', 'silhouette', 'stream', 'terminal']
The sentence is: light streams through windows at the railroad and ferry terminal creating a beautiful silhouette

Concepts: ['chair', 'couch', 'hang', 'room', 'wall']
The sentence is: A room with a couch, chairs and art hanging on the wall.

Concepts: ['boat', 'building', 'harbour', 'moor', 'quay']
The sentence is: the harbour and port with fishing boats moored and old buildings on the quay

Concepts: ['admirer', 'arrive', 'commander', 'crowd', 'greet']
The sentence is: military commander is greeted by a crowd of admirers as he arrives

Now create a sentence using the following concepts:

Concepts: {concepts}
The sentence is:</pre></details>
</div>
</div>
</section>
<section id="feedback-prompt-template" class="level2">
<h2 class="anchored" data-anchor-id="feedback-prompt-template">2. feedback prompt template</h2>
<div id="fe541c2c-39cc-46a8-8936-a25b449969db" class="cell" data-scrolled="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_feedback_prompt_template():</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    examples_url<span class="op">=</span><span class="st">'https://raw.githubusercontent.com/madaan/self-refine/main/data/prompt/commongen/feedback.jsonl'</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> download_examples(examples_url)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    prompt_head <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="st">I want you to provide feedbacks on a sentence that is constructed using given concepts. </span><span class="ch">\</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="st">Follow the following instructions:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="st">- First, find out what concepts from the concept list are missing from the constructed sentence</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="st">- Second, if the sentence doesn't makes sense, provide short explanation; otherwise, provide "None" as your answer.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="st">Here are some examples:</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    prompt_end <span class="op">=</span><span class="st">"""</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="st">Now provide your feedbacks on the following concepts and the constructed sentence.</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="st">- First, find out what concepts from the concept list are missing from the constructed sentence</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="st">- Second, if the sentence doesn't makes sense, provide short explanation; otherwise, provide "None" as your answer.</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="st">Concepts: </span><span class="sc">{concepts}</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="st">Constructed sentence: </span><span class="sc">{sentence}</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    example_template <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="st">Concepts: </span><span class="sc">{concepts}</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="st">Constructed sentence: </span><span class="sc">{sentence}</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="st">Missing concepts: </span><span class="sc">{missing_concepts}</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="st">Commonsense Feedback: </span><span class="sc">{commonsense_feedback}</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    examples_prompt <span class="op">=</span> <span class="st">''</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example <span class="kw">in</span> examples:</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        examples_prompt <span class="op">+=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> example_template.<span class="bu">format</span>(</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            concepts<span class="op">=</span>example[<span class="st">'concepts'</span>],</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            sentence<span class="op">=</span>example[<span class="st">'sentence'</span>],</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>            missing_concepts<span class="op">=</span><span class="st">', '</span>.join(example[<span class="st">'concept_feedback'</span>]).replace(<span class="st">'NONE'</span>, <span class="st">'None'</span>),</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            commonsense_feedback<span class="op">=</span>example[<span class="st">'commonsense_feedback'</span>].replace(<span class="st">'NONE'</span>, <span class="st">'None'</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    prompt_template <span class="op">=</span> prompt_head <span class="op">+</span> examples_prompt <span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> prompt_end</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prompt_template</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4a648cf0-1a0b-4bed-af27-465246dade8f" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>feedback_prompt_template <span class="op">=</span> construct_feedback_prompt_template()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>utils.display_html(feedback_prompt_template, <span class="st">'Show feedback prompt template'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<details><summary>Show feedback prompt template</summary><pre>I want you to provide feedbacks on a sentence that is constructed using given concepts. Follow the following instructions:
- First, find out what concepts from the concept list are missing from the constructed sentence
- Second, if the sentence doesn't makes sense, provide short explanation; otherwise, provide "None" as your answer.

Here are some examples:

Concepts: ['beat', 'drum', 'pen', 'sit', 'use']
Constructed sentence: A man uses a drum to beat a pen.
Missing concepts: sit
Commonsense Feedback: None

Concepts: ['chair', 'clipper', 'cut', 'hair', 'sit']
Constructed sentence: A girl sitting on the couch with her hair up.
Missing concepts: clipper, cut, chair
Commonsense Feedback: None

Concepts: ['grass', 'hose', 'spray', 'stand', 'water']
Constructed sentence: A man standing next to a water dripping out of the grass.
Missing concepts: hose, spray
Commonsense Feedback: None

Concepts: ['front', 'gong', 'hit', 'mallet', 'stand']
Constructed sentence: The musician hit the gong with a mallet while standing in front of the audince.
Missing concepts: None
Commonsense Feedback: None

Concepts: ['ball', 'dunk', 'hoop', 'jump', 'run']
Constructed sentence: A young boy runs up to the hoop and jumps off of the ball.
Missing concepts: dunk
Commonsense Feedback: None

Concepts: ['card', 'chip', 'deal', 'dealer', 'table']
Constructed sentence: a dealer offers a card to a group of people at a table
Missing concepts: chip, deal
Commonsense Feedback: None

Concepts: ['clean', 'climb', 'gutter', 'house', 'ladder']
Constructed sentence: A man is climbing a ladder to clean a gutter in a house.
Missing concepts: None
Commonsense Feedback: None

Concepts: ['animal', 'catch', 'horse', 'lasso', 'ride']
Constructed sentence: A horse is being caught by a cowboy with a lasso.
Missing concepts: animal, ride
Commonsense Feedback: None

Concepts: ['beat', 'drum', 'pen', 'sit', 'use']
Constructed sentence: The drum sits on the pen and uses the beat.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because a drum cannot sit on a pen and use a beat.

Concepts: ['chair', 'clipper', 'cut', 'hair', 'sit']
Constructed sentence: The clipper sits on the chair.
Missing concepts: cut, hair
Commonsense Feedback: The sentence does not make sense because a clipper cannot sit on a chair.

Concepts: ['grass', 'hose', 'spray', 'stand', 'water']
Constructed sentence: The water stands in the grass.
Missing concepts: hose, spray
Commonsense Feedback: The sentence does not make sense because water cannot stand in grass.

Concepts: ['front', 'gong', 'hit', 'mallet', 'stand']
Constructed sentence: On a sunny day, a mallet stands in the front of a gong and it hit the gong with a loud sound.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because a mallet cannot stand in the front of a gong and cannot hit it.

Concepts: ['ball', 'dunk', 'hoop', 'jump', 'run']
Constructed sentence: The ball runs to the hoop and dunks.
Missing concepts: jump
Commonsense Feedback: The sentence does not make sense because a ball cannot run and dunk.

Concepts: ['card', 'chip', 'deal', 'dealer', 'table']
Constructed sentence: The chip deals a card to the dealer at the table.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because a chip cannot deal a card to a dealer.

Concepts: ['clean', 'climb', 'gutter', 'house', 'ladder']
Constructed sentence: The ladder climbs to the house and cleans the gutter.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because a ladder cannot climb to a house and cannot clean a gutter.

Concepts: ['animal', 'catch', 'horse', 'lasso', 'ride']
Constructed sentence: The horse catches the lasso and rides on it.
Missing concepts: animal
Commonsense Feedback: The sentence does not make sense because a horse cannot catch a lasso and ride on it.

Now provide your feedbacks on the following concepts and the constructed sentence.
- First, find out what concepts from the concept list are missing from the constructed sentence
- Second, if the sentence doesn't makes sense, provide short explanation; otherwise, provide "None" as your answer.

Concepts: {concepts}
Constructed sentence: {sentence}</pre></details>
</div>
</div>
</section>
<section id="refine-prompt-template" class="level2">
<h2 class="anchored" data-anchor-id="refine-prompt-template">3. refine prompt template</h2>
<div id="3aba2b9d-11c5-486f-9f49-153f0e92837f" class="cell" data-scrolled="true" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_refine_prompt_templates():</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    examples_url<span class="op">=</span><span class="st">'https://raw.githubusercontent.com/madaan/self-refine/main/data/prompt/commongen/iterate.jsonl'</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> download_examples(examples_url)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    prompt_head <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ss">We are having multi-turn conversation in order to create a sentence that contains all given concepts. </span><span class="ch">\</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ss">I will provide you with my feedbacks on the sentence regarding missing concepts and whether the sentence makes sense. </span><span class="ch">\</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ss">Your task is to improve the provided sentence based on my feedbacks.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="ss">Here are </span><span class="sc">{</span><span class="bu">len</span>(examples)<span class="sc">}</span><span class="ss"> examples of our past conversations:</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span>.strip()</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    generation_prompt <span class="op">=</span> <span class="st">'Impove the sentence using the above feedbacks.'</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    example_prompt_head <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="st">Example </span><span class="sc">{i}</span><span class="st">:</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="st">User:</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="st">Concepts: </span><span class="sc">{concepts}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="st">Sentence: </span><span class="sc">{sentence}</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="st">Missing concepts: </span><span class="sc">{missing_concepts}</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="st">Commonsense Feedback: </span><span class="sc">{commonsense_feedback}</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="sc">{generation_prompt}</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    example_prompt_assistant <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="st">Assistant:</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="st">Sentence: </span><span class="sc">{sentence}</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    example_prompt_user <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="st">User:</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="st">Missing concepts: </span><span class="sc">{missing_concepts}</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="st">Commonsense Feedback: </span><span class="sc">{commonsense_feedback}</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="sc">{generation_prompt}</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    prompt_end_0 <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="st">Now let's start a new conversation so that you can improve a constructed sentence based on my feedbacks.</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="st">Concepts: </span><span class="sc">{concepts}</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="st">Sentence: </span><span class="sc">{sentence}</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="st">Missing concepts: </span><span class="sc">{missing_concepts}</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="st">Commonsense Feedback: </span><span class="sc">{commonsense_feedback}</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    prompt_end_1 <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="st">Missing concepts: </span><span class="sc">{missing_concepts}</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="st">Commonsense Feedback: </span><span class="sc">{commonsense_feedback}</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>.strip()</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    examples_prompt <span class="op">=</span> <span class="st">''</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, example <span class="kw">in</span> <span class="bu">enumerate</span>(examples):</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        sentence_to_feedback <span class="op">=</span> example[<span class="st">'sentence_to_feedback'</span>]</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        examples_prompt <span class="op">+=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> example_prompt_head.<span class="bu">format</span>(</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>            i<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span>,</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>            concepts<span class="op">=</span>example[<span class="st">'concepts'</span>],</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>            sentence<span class="op">=</span>sentence_to_feedback[<span class="dv">0</span>][<span class="st">'sentence'</span>],</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>            missing_concepts<span class="op">=</span>sentence_to_feedback[<span class="dv">0</span>][<span class="st">'concept_feedback'</span>],</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>            commonsense_feedback<span class="op">=</span>sentence_to_feedback[<span class="dv">0</span>][<span class="st">'commonsense_feedback'</span>],</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>            generation_prompt<span class="op">=</span>generation_prompt</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> x <span class="kw">in</span> sentence_to_feedback[<span class="dv">1</span>:]:</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>            examples_prompt <span class="op">+=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span> <span class="op">+</span> example_prompt_assistant.<span class="bu">format</span>(sentence<span class="op">=</span>x[<span class="st">'sentence'</span>])</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>            examples_prompt <span class="op">+=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span> <span class="op">+</span> example_prompt_user.<span class="bu">format</span>(</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>                missing_concepts<span class="op">=</span>x[<span class="st">'concept_feedback'</span>],</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>                commonsense_feedback<span class="op">=</span>x[<span class="st">'commonsense_feedback'</span>],</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>                generation_prompt<span class="op">=</span>generation_prompt</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remove the last generation_prompt</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> examples_prompt.rfind(generation_prompt)</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        examples_prompt <span class="op">=</span> examples_prompt[<span class="dv">0</span>:idx].strip()</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    prompt_template_0 <span class="op">=</span> prompt_head<span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> examples_prompt <span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> prompt_end_0 <span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> generation_prompt</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>    prompt_template_1 <span class="op">=</span> prompt_end_1 <span class="op">+</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span> <span class="op">+</span> generation_prompt</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prompt_template_0, prompt_template_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a46a9fcd-2f2d-437a-9f0f-39dcd8a65410" class="cell" data-scrolled="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>refine_prompt_template_0, refine_prompt_template_1 <span class="op">=</span> construct_refine_prompt_templates()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>utils.display_html(refine_prompt_template_0, <span class="st">'Show refine prompt template for the first refinement'</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>utils.display_html(refine_prompt_template_1, <span class="st">'Show refine prompt template for the rest refinement'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<details><summary>Show refine prompt template for the first refinement</summary><pre>We are having multi-turn conversation in order to create a sentence that contains all given concepts. I will provide you with my feedbacks on the sentence regarding missing concepts and whether the sentence makes sense. Your task is to improve the provided sentence based on my feedbacks.

Here are 8 examples of our past conversations:

Example 1:
User:
Concepts: ['beat', 'drum', 'pen', 'sit', 'use']
Sentence: The drum sits on the pen and uses it to beat.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because a drum cannot sit on a pen and use it to beat.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The drummer uses the drum to beat.
User:
Missing concepts: sit, pen
Commonsense Feedback: None

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The drummer sits behind the drum and uses it to beat the pen.
User:
Missing concepts: None
Commonsense Feedback: None

Example 2:
User:
Concepts: ['chair', 'clipper', 'cut', 'hair', 'sit']
Sentence: A couch shaped girl sitting on the chair with her hair clipper.
Missing concepts: cut
Commonsense Feedback: The sentence does not make sense because a couch is not a shape and a hair clipper is not an item of clothing.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: A girl on the chair with her hair clipper and cutting her hair.
User:
Missing concepts: sit
Commonsense Feedback: None

Impove the sentence using the above feedbacks.
Assistant:
Sentence: A girl sitting on the chair with a hair clipper, cutting her hair up.
User:
Missing concepts: None
Commonsense Feedback: None

Example 3:
User:
Concepts: ['grass', 'hose', 'spray', 'stand', 'water']
Sentence: The grass is standing tall and a hose is spraying it with spray.
Missing concepts: water
Commonsense Feedback: The sentence does not make sense because it is not clear what 'spray' is referring to, and grass does not have the ability to stand upright like a human or animal.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The hose is spraying water onto the grass that is standing like a person.
User:
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because grass cannot stand upright like a human or animal.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: A person is standing on the grass, holding a hose that is spraying water onto the grass.
User:
Missing concepts: None
Commonsense Feedback: None

Example 4:
User:
Concepts: ['front', 'gong', 'hit', 'mallet', 'stand']
Sentence: A mallet is standing in front of a gong.
Missing concepts: hit
Commonsense Feedback: The sentence does not make sense because a mallet cannot stand in the front of a gong.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: A musician stands in front of a gong with a mallet.
User:
Missing concepts: None
Commonsense Feedback: None

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The musician stands in front of the gong and hits it with a mallet.
User:
Missing concepts: None
Commonsense Feedback: None

Example 5:
User:
Concepts: ['ball', 'dunk', 'hoop', 'jump', 'run']
Sentence: The ball runs to the hoop and dunks it.
Missing concepts: jump
Commonsense Feedback: The sentence does not make sense because a ball cannot run and dunk.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The ball jumps to the hoop and dunks it.
User:
Missing concepts: run
Commonsense Feedback: The sentence does not make sense because a ball cannot jump.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: A basketball player runs up to the hoop and jumps off of the ball to dunk it.
User:
Missing concepts: None
Commonsense Feedback: None

Example 6:
User:
Concepts: ['card', 'chip', 'deal', 'dealer', 'table']
Sentence: A dealer offers a card to a group of people at a table.
Missing concepts: chip, deal
Commonsense Feedback: The sentence does not make sense because a chip cannot deal a card to a dealer.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The dealer deals a card to a group of people.
User:
Missing concepts: chip
Commonsense Feedback: None

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The dealer deals a card to a group of people around the table with a chip at the table.
User:
Missing concepts: None
Commonsense Feedback: None

Example 7:
User:
Concepts: ['clean', 'climb', 'gutter', 'house', 'ladder']
Sentence: The house is clean and a ladder is trying to climb.
Missing concepts: climb
Commonsense Feedback: The sentence does not make sense because ladders cannot climb by themselves.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: A person is cleaning the gutter of the house by climbing onto the roof with a ladder made of glass.
User:
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because ladders are not made of glass, and using a glass ladder would be dangerous and impractical.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: A person is cleaning the gutter of the house by using a ladder to climb onto the roof and brushing away the dirt.
User:
Missing concepts: None
Commonsense Feedback: None

Example 8:
User:
Concepts: ['animal', 'catch', 'horse', 'lasso', 'ride']
Sentence: The horse catches the lasso and rides on it.
Missing concepts: animal
Commonsense Feedback: The sentence does not make sense because a horse cannot catch a lasso and ride on it.

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The cowboy catches a horse with a lasso and rides on it.
User:
Missing concepts: animal
Commonsense Feedback: None

Impove the sentence using the above feedbacks.
Assistant:
Sentence: The cowboy catches the horse with a lasso and rides it.
User:
Missing concepts: None
Commonsense Feedback: None

Now let's start a new conversation so that you can improve a constructed sentence based on my feedbacks.

Concepts: {concepts}
Sentence: {sentence}
Missing concepts: {missing_concepts}
Commonsense Feedback: {commonsense_feedback}

Impove the sentence using the above feedbacks.</pre></details>
</div>
<div class="cell-output cell-output-display">
<details><summary>Show refine prompt template for the rest refinement</summary><pre>Missing concepts: {missing_concepts}
Commonsense Feedback: {commonsense_feedback}

Impove the sentence using the above feedbacks.</pre></details>
</div>
</div>
</section>
</section>
<section id="experiments" class="level1">
<h1>Experiments</h1>
<div id="9dcc8e14-ec21-43f2-8c16-4ccc07e15599" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ask_llm(prompt, model):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> model.generate_content(prompt)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.text.strip()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># a help function to remove prefix from model's outputs</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_prefix_if_exist(prefix, text):</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prefix <span class="kw">in</span> text.lower():</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        start_idx <span class="op">=</span> text.lower().index(prefix) <span class="op">+</span> <span class="bu">len</span>(prefix)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> text[start_idx:].strip()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="811068ba-fb39-499e-b1b7-fbaf999a5cdd" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> concepts_from_sentence(sentence, concepts):</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""extract concepts from a sentence using NLTK and spacy."""</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    words <span class="op">=</span> nltk.word_tokenize(sentence)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    lemmas <span class="op">=</span> [t.lemma_ <span class="cf">for</span> t <span class="kw">in</span> nlp(sentence)]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    tokens <span class="op">=</span> <span class="bu">set</span>(words <span class="op">+</span> lemmas)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    found_concepts <span class="op">=</span> <span class="bu">set</span>(concepts).intersection(tokens)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> found_concepts</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fix_missing_concepts(concept_feedback, found_concepts):</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""fix model's concept feedback if there are any mistakes."""</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    words <span class="op">=</span> concept_feedback.split(<span class="st">','</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    words <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> x: x.strip(), words)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    words <span class="op">=</span> <span class="bu">set</span>(<span class="bu">filter</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(x)<span class="op">&gt;</span><span class="dv">0</span>, words))    </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    missing_concepts <span class="op">=</span> words.difference(found_concepts)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> missing_concepts:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">', '</span>.join(missing_concepts)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'None'</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_feedback_outputs(outputs):</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    concept_feedback, commonsense_feedback <span class="op">=</span> outputs.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>,maxsplit<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    concept_feedback <span class="op">=</span> remove_prefix_if_exist(<span class="st">'missing concepts:'</span>, concept_feedback)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    commonsense_feedback <span class="op">=</span> remove_prefix_if_exist(<span class="st">'commonsense feedback:'</span>, commonsense_feedback)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> concept_feedback, commonsense_feedback</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="588fcfb2-9d78-4246-8602-de3c0622d193" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_feedback(sentence, concepts, model):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    found_concepts <span class="op">=</span> concepts_from_sentence(sentence, concepts)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    feedback_prompt <span class="op">=</span> feedback_prompt_template.<span class="bu">format</span>(concepts<span class="op">=</span>concepts, sentence<span class="op">=</span>sentence)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    feedback_outputs <span class="op">=</span> ask_llm(feedback_prompt, model)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="st">"="</span><span class="op">*</span><span class="dv">10</span><span class="sc">}</span><span class="ss"> DEBUG </span><span class="sc">{</span><span class="st">"="</span><span class="op">*</span><span class="dv">10</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Sentence: </span><span class="sc">{</span>sentence<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(feedback_outputs)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="st">"-"</span><span class="op">*</span><span class="dv">10</span><span class="sc">}</span><span class="ss">-------</span><span class="sc">{</span><span class="st">"-"</span><span class="op">*</span><span class="dv">10</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    concept_feedback, commonsense_feedback <span class="op">=</span> process_feedback_outputs(feedback_outputs)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    fixed_missing_concepts <span class="op">=</span> fix_missing_concepts(concept_feedback, found_concepts)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fixed_missing_concepts, commonsense_feedback</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="13be2720-26cd-452e-b9ed-cd3b3d5c3c2c" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_refine_loop(sentence, concepts, model, max_tries<span class="op">=</span><span class="dv">5</span>, throttle<span class="op">=</span><span class="va">False</span>, throttle_value<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    refine_gen_prefix <span class="op">=</span> <span class="st">'sentence:'</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    refine_prompt_template <span class="op">=</span> refine_prompt_template_0</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    chat <span class="op">=</span> model.start_chat()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(max_tries):</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        start_time <span class="op">=</span> time.perf_counter()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        missing_concepts, commonsense_feedback <span class="op">=</span> get_feedback(sentence, concepts, model)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'none'</span> <span class="op">==</span> missing_concepts.lower() <span class="kw">and</span> <span class="st">'none'</span> <span class="op">==</span> commonsense_feedback.lower():</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                chat.history.append(Content(</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                    role<span class="op">=</span><span class="st">'user'</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                    parts<span class="op">=</span>[Part(text<span class="op">=</span><span class="st">'Missing concepts: None</span><span class="ch">\n</span><span class="st">Commonsense Feedback: None'</span>)])</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> sentence, chat.history</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> throttle:</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>            utils.throttle(start_time, throttle_value)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        start_time <span class="op">=</span> time.perf_counter()</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        refine_prompt <span class="op">=</span> refine_prompt_template.<span class="bu">format</span>(</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            concepts<span class="op">=</span>concepts,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            sentence<span class="op">=</span>sentence,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>            missing_concepts<span class="op">=</span>missing_concepts,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            commonsense_feedback<span class="op">=</span>commonsense_feedback</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        refine_outputs <span class="op">=</span> chat.send_message(refine_prompt).text.strip()</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> refine_gen_prefix <span class="kw">in</span> refine_outputs.lower():</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            start_idx <span class="op">=</span> refine_outputs.lower().index(refine_gen_prefix) <span class="op">+</span> <span class="bu">len</span>(refine_gen_prefix)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>            sentence <span class="op">=</span> refine_outputs[start_idx:].strip()</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            sentence <span class="op">=</span> refine_outputs</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>            refine_prompt_template <span class="op">=</span> refine_prompt_template_1</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> throttle:</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>            utils.throttle(start_time, throttle_value)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    missing_concepts, commonsense_feedback <span class="op">=</span> get_feedback(sentence, concepts, model)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    parts_text <span class="op">=</span> <span class="ss">f'Missing concepts: </span><span class="sc">{</span>missing_concepts<span class="sc">}</span><span class="ch">\n</span><span class="ss">Commonsense Feedback: </span><span class="sc">{</span>commonsense_feedback<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    chat.history.append(Content(</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span><span class="st">'user'</span>, </span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        parts<span class="op">=</span>[Part(text<span class="op">=</span>parts_text)])</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sentence, chat.history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="configure-both-gemini-1.5-flash-and-gemini-1.5-pro-models." class="level2">
<h2 class="anchored" data-anchor-id="configure-both-gemini-1.5-flash-and-gemini-1.5-pro-models.">Configure both <code>gemini-1.5-flash</code> and <code>gemini-1.5-pro</code> models.</h2>
<div id="a2b46690-e2e7-4380-adcc-b87bf1df348b" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>genai.configure(api_key<span class="op">=</span>os.environ[<span class="st">'GOOGLE_API_KEY'</span>])</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>safe <span class="op">=</span> [</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"category"</span>: <span class="st">"HARM_CATEGORY_HARASSMENT"</span>, <span class="st">"threshold"</span>: <span class="st">"BLOCK_NONE"</span>},</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"category"</span>: <span class="st">"HARM_CATEGORY_HATE_SPEECH"</span>, <span class="st">"threshold"</span>: <span class="st">"BLOCK_NONE"</span>},</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"category"</span>: <span class="st">"HARM_CATEGORY_SEXUALLY_EXPLICIT"</span>, <span class="st">"threshold"</span>: <span class="st">"BLOCK_NONE"</span>},</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"category"</span>: <span class="st">"HARM_CATEGORY_DANGEROUS_CONTENT"</span>, <span class="st">"threshold"</span>: <span class="st">"BLOCK_NONE"</span>}</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>model_flash <span class="op">=</span> genai.GenerativeModel(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gemini-1.5-flash-001'</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    safety_settings<span class="op">=</span>safe,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    system_instruction<span class="op">=</span><span class="st">'You are a helpful assistant. Avoid markdown in your response. Plain text only.'</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    generation_config<span class="op">=</span>{<span class="st">'temperature'</span>: <span class="fl">0.7</span>, <span class="st">'max_output_tokens'</span>: <span class="dv">256</span>}</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>model_pro <span class="op">=</span> genai.GenerativeModel(</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gemini-1.5-pro-001'</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    safety_settings<span class="op">=</span>safe,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    system_instruction<span class="op">=</span><span class="st">'You are a helpful assistant. Avoid markdown in your response. Plain text only.'</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    generation_config<span class="op">=</span>{<span class="st">'temperature'</span>: <span class="fl">0.7</span>, <span class="st">'max_output_tokens'</span>: <span class="dv">256</span>}</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exp-01-using-gemini-1.5-flash" class="level2">
<h2 class="anchored" data-anchor-id="exp-01-using-gemini-1.5-flash">Exp 01: using <code>gemini-1.5-flash</code></h2>
<section id="generate-the-initital-sentence" class="level3">
<h3 class="anchored" data-anchor-id="generate-the-initital-sentence">1. generate the initital sentence</h3>
<div id="8e40dc01-a440-42e0-be17-61f7a1754992" class="cell" data-scrolled="true" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># an example from authors' [commongen_hard.jsonl](https://github.com/madaan/self-refine/blob/main/data/prompt/commongen/commongen_hard.jsonl)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>concepts <span class="op">=</span> [<span class="st">"use"</span>, <span class="st">"goat"</span>, <span class="st">"wine"</span>, <span class="st">"frisbee"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">"leap"</span>, <span class="st">"pole"</span>, <span class="st">"tell"</span>, <span class="st">"pencil"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"spin"</span>, <span class="st">"birdie"</span>, <span class="st">"catcher"</span>, <span class="st">"fence"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"world"</span>, <span class="st">"step"</span>, <span class="st">"chop"</span>, <span class="st">"sword"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"march"</span>, <span class="st">"stage"</span>, <span class="st">"axe"</span>, <span class="st">"bat"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"place"</span>, <span class="st">"roller"</span>, <span class="st">"tomato"</span>]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>init_prompt <span class="op">=</span> init_prompt_template.<span class="bu">format</span>(concepts<span class="op">=</span>concepts)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>utils.display_html(init_prompt, <span class="st">'Show init prompt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<details><summary>Show init prompt</summary><pre>I want you to create a sentence that contains all the specified concepts.

Here are some examples:

Concepts: ['footage', 'motion', 'ruin', 'tilt', 'window']
The sentence is: time lapse footage with tilt up motion of the sun streaking through window of ruin

Concepts: ['cause', 'hate', 'hut', 'local', 'love']
The sentence is: new beach huts on the island have caused some controversy some locals love them others hate them

Concepts: ['call', 'contain', 'dress', 'gown', 'wallpaper']
The sentence is: the wallpaper probably containing a gown and a dinner dress called

Concepts: ['knock', 'leave', 'pew', 'rush', 'seat']
The sentence is: She leaves the confessional and rushes past a pew, knocking a Bible from the seat.

Concepts: ['help', 'moment', 'spend', 'uplift', 'world']
The sentence is: every moment that we spend in higher consciousness helps uplift the consciousness of the whole world

Concepts: ['label', 'pende', 'stamp', 'text', 'write']
The sentence is: abstract stamp or label with the text pending written inside

Concepts: ['create', 'ferry', 'silhouette', 'stream', 'terminal']
The sentence is: light streams through windows at the railroad and ferry terminal creating a beautiful silhouette

Concepts: ['chair', 'couch', 'hang', 'room', 'wall']
The sentence is: A room with a couch, chairs and art hanging on the wall.

Concepts: ['boat', 'building', 'harbour', 'moor', 'quay']
The sentence is: the harbour and port with fishing boats moored and old buildings on the quay

Concepts: ['admirer', 'arrive', 'commander', 'crowd', 'greet']
The sentence is: military commander is greeted by a crowd of admirers as he arrives

Now create a sentence using the following concepts:

Concepts: ['use', 'goat', 'wine', 'frisbee', 'leap', 'pole', 'tell', 'pencil', 'spin', 'birdie', 'catcher', 'fence', 'world', 'step', 'chop', 'sword', 'march', 'stage', 'axe', 'bat', 'place', 'roller', 'tomato']
The sentence is:</pre></details>
</div>
</div>
<div id="6181b187-a8cf-40ac-94be-ce8eb7dabb32" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>init_outputs <span class="op">=</span> ask_llm(init_prompt, model_flash)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sentence <span class="op">=</span> remove_prefix_if_exist(<span class="st">'the sentence is:'</span>, init_outputs)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>sentence</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>'The goat leaps over the fence, using the frisbee as a springboard, while the world spins around him; a catcher tells the story of a place where they chop tomatoes with a sword, march on stage with an axe, and bat a roller with a pencil.'</code></pre>
</div>
</div>
</section>
<section id="run-the-refine-loop" class="level3">
<h3 class="anchored" data-anchor-id="run-the-refine-loop">2. run the refine loop</h3>
<div id="43a87785-7ced-4ab6-b313-b473ff534bb0" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>sentence, history <span class="op">=</span> run_refine_loop(sentence, concepts, model_flash)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>========== DEBUG ==========
Sentence: The goat leaps over the fence, using the frisbee as a springboard, while the world spins around him; a catcher tells the story of a place where they chop tomatoes with a sword, march on stage with an axe, and bat a roller with a pencil.
Missing concepts: use, wine, pole, birdie, step, axe, bat
Commonsense Feedback: The sentence does not make sense because a goat cannot use a frisbee as a springboard and a catcher cannot chop tomatoes with a sword, march on stage with an axe, and bat a roller with a pencil.
---------------------------
========== DEBUG ==========
Sentence: The goat leaps over the fence, using a pole to step over it, while the world spins around him; a catcher tells the story of a place where they chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil, while a birdie uses a wine glass to spin a frisbee.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because it is a nonsensical combination of actions and objects. A goat cannot use a pole to step over a fence, the world does not spin around a goat, and the described actions are not logically connected.
---------------------------
========== DEBUG ==========
Sentence: A catcher tells the story of a place where they chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil.  A goat uses a pole to leap over the fence and a birdie spins a frisbee with a wine glass.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because it describes actions that are not logically possible or typical. For example, chopping tomatoes with an axe, marching on stage with a sword, batting a roller with a pencil, using a pole to leap over a fence, and spinning a frisbee with a wine glass are all nonsensical actions.
---------------------------
========== DEBUG ==========
Sentence: A goat leaps over a fence using a pole. A catcher tells a story of a place where they chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil.  A birdie spins a frisbee, taking a sip of wine as it does so.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because it is a nonsensical story. Goats cannot leap over fences using poles. Catchers do not tell stories about chopping tomatoes with axes, marching on stage with swords, and batting rollers with pencils.  Birds cannot spin frisbees and take sips of wine.
---------------------------
========== DEBUG ==========
Sentence: A goat leaps over a fence, its hooves hitting the ground with a soft thud. A catcher tells a story of a place where people chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil. A birdie spins a frisbee in the air, watching it soar through the sky.
Missing concepts: use, wine, pole, world, step
Commonsense Feedback: None
---------------------------
========== DEBUG ==========
Sentence: A goat leaps over a fence, using a pole to step over it, as the world spins around him. A catcher tells a story of a place where people chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil. A birdie spins a frisbee in the air, taking a sip of wine as it does so.
Missing concepts: None
Commonsense Feedback: The sentence does not make sense because a goat cannot use a pole to step over a fence, a catcher cannot tell a story of a place where people chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil, and a birdie cannot spin a frisbee in the air while taking a sip of wine.
---------------------------</code></pre>
</div>
</div>
<div id="77b1f14b-b07e-4957-bd37-3f3f114cca0f" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sentence</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>'A goat leaps over a fence, using a pole to step over it, as the world spins around him. A catcher tells a story of a place where people chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil. A birdie spins a frisbee in the air, taking a sip of wine as it does so.'</code></pre>
</div>
</div>
<div id="9de41b40-1d5b-455c-8f4b-980371c48447" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>last_feedback <span class="op">=</span> history[<span class="op">-</span><span class="dv">1</span>].parts[<span class="dv">0</span>].text</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(last_feedback)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Missing concepts: None
Commonsense Feedback: The sentence does not make sense because a goat cannot use a pole to step over a fence, a catcher cannot tell a story of a place where people chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil, and a birdie cannot spin a frisbee in the air while taking a sip of wine.</code></pre>
</div>
</div>
<div id="9fa9025a-a3b1-4b7c-b89f-7b485abdbe87" class="cell" data-scrolled="true" data-execution_count="86">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>utils.display_html(history, <span class="st">'Show refine history'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<details><summary>Show refine history</summary><pre>[parts {
  text: "We are having multi-turn conversation in order to create a sentence that contains all given concepts. I will provide you with my feedbacks on the sentence regarding missing concepts and whether the sentence makes sense. Your task is to improve the provided sentence based on my feedbacks.\n\nHere are 8 examples of our past conversations:\n\nExample 1:\nUser:\nConcepts: [\'beat\', \'drum\', \'pen\', \'sit\', \'use\']\nSentence: The drum sits on the pen and uses it to beat.\nMissing concepts: None\nCommonsense Feedback: The sentence does not make sense because a drum cannot sit on a pen and use it to beat.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The drummer uses the drum to beat.\nUser:\nMissing concepts: sit, pen\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The drummer sits behind the drum and uses it to beat the pen.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 2:\nUser:\nConcepts: [\'chair\', \'clipper\', \'cut\', \'hair\', \'sit\']\nSentence: A couch shaped girl sitting on the chair with her hair clipper.\nMissing concepts: cut\nCommonsense Feedback: The sentence does not make sense because a couch is not a shape and a hair clipper is not an item of clothing.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A girl on the chair with her hair clipper and cutting her hair.\nUser:\nMissing concepts: sit\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A girl sitting on the chair with a hair clipper, cutting her hair up.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 3:\nUser:\nConcepts: [\'grass\', \'hose\', \'spray\', \'stand\', \'water\']\nSentence: The grass is standing tall and a hose is spraying it with spray.\nMissing concepts: water\nCommonsense Feedback: The sentence does not make sense because it is not clear what \'spray\' is referring to, and grass does not have the ability to stand upright like a human or animal.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The hose is spraying water onto the grass that is standing like a person.\nUser:\nMissing concepts: None\nCommonsense Feedback: The sentence does not make sense because grass cannot stand upright like a human or animal.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A person is standing on the grass, holding a hose that is spraying water onto the grass.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 4:\nUser:\nConcepts: [\'front\', \'gong\', \'hit\', \'mallet\', \'stand\']\nSentence: A mallet is standing in front of a gong.\nMissing concepts: hit\nCommonsense Feedback: The sentence does not make sense because a mallet cannot stand in the front of a gong.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A musician stands in front of a gong with a mallet.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The musician stands in front of the gong and hits it with a mallet.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 5:\nUser:\nConcepts: [\'ball\', \'dunk\', \'hoop\', \'jump\', \'run\']\nSentence: The ball runs to the hoop and dunks it.\nMissing concepts: jump\nCommonsense Feedback: The sentence does not make sense because a ball cannot run and dunk.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The ball jumps to the hoop and dunks it.\nUser:\nMissing concepts: run\nCommonsense Feedback: The sentence does not make sense because a ball cannot jump.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A basketball player runs up to the hoop and jumps off of the ball to dunk it.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 6:\nUser:\nConcepts: [\'card\', \'chip\', \'deal\', \'dealer\', \'table\']\nSentence: A dealer offers a card to a group of people at a table.\nMissing concepts: chip, deal\nCommonsense Feedback: The sentence does not make sense because a chip cannot deal a card to a dealer.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The dealer deals a card to a group of people.\nUser:\nMissing concepts: chip\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The dealer deals a card to a group of people around the table with a chip at the table.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 7:\nUser:\nConcepts: [\'clean\', \'climb\', \'gutter\', \'house\', \'ladder\']\nSentence: The house is clean and a ladder is trying to climb.\nMissing concepts: climb\nCommonsense Feedback: The sentence does not make sense because ladders cannot climb by themselves.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A person is cleaning the gutter of the house by climbing onto the roof with a ladder made of glass.\nUser:\nMissing concepts: None\nCommonsense Feedback: The sentence does not make sense because ladders are not made of glass, and using a glass ladder would be dangerous and impractical.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A person is cleaning the gutter of the house by using a ladder to climb onto the roof and brushing away the dirt.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 8:\nUser:\nConcepts: [\'animal\', \'catch\', \'horse\', \'lasso\', \'ride\']\nSentence: The horse catches the lasso and rides on it.\nMissing concepts: animal\nCommonsense Feedback: The sentence does not make sense because a horse cannot catch a lasso and ride on it.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The cowboy catches a horse with a lasso and rides on it.\nUser:\nMissing concepts: animal\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The cowboy catches the horse with a lasso and rides it.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nNow let\'s start a new conversation so that you can improve a constructed sentence based on my feedbacks.\n\nConcepts: [\'use\', \'goat\', \'wine\', \'frisbee\', \'leap\', \'pole\', \'tell\', \'pencil\', \'spin\', \'birdie\', \'catcher\', \'fence\', \'world\', \'step\', \'chop\', \'sword\', \'march\', \'stage\', \'axe\', \'bat\', \'place\', \'roller\', \'tomato\']\nSentence: The goat leaps over the fence, using the frisbee as a springboard, while the world spins around him; a catcher tells the story of a place where they chop tomatoes with a sword, march on stage with an axe, and bat a roller with a pencil.\nMissing concepts: pole, step, birdie, wine\nCommonsense Feedback: The sentence does not make sense because a goat cannot use a frisbee as a springboard and a catcher cannot chop tomatoes with a sword, march on stage with an axe, and bat a roller with a pencil.\n\nImpove the sentence using the above feedbacks."
}
role: "user"
, parts {
  text: "The goat leaps over the fence, using a pole to step over it, while the world spins around him; a catcher tells the story of a place where they chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil, while a birdie uses a wine glass to spin a frisbee. \n"
}
role: "model"
, parts {
  text: "Missing concepts: None\nCommonsense Feedback: The sentence does not make sense because it is a nonsensical combination of actions and objects. A goat cannot use a pole to step over a fence, the world does not spin around a goat, and the described actions are not logically connected.\n\nImpove the sentence using the above feedbacks."
}
role: "user"
, parts {
  text: "A catcher tells the story of a place where they chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil.  A goat uses a pole to leap over the fence and a birdie spins a frisbee with a wine glass. \n"
}
role: "model"
, parts {
  text: "Missing concepts: None\nCommonsense Feedback: The sentence does not make sense because it describes actions that are not logically possible or typical. For example, chopping tomatoes with an axe, marching on stage with a sword, batting a roller with a pencil, using a pole to leap over a fence, and spinning a frisbee with a wine glass are all nonsensical actions.\n\nImpove the sentence using the above feedbacks."
}
role: "user"
, parts {
  text: "A goat leaps over a fence using a pole. A catcher tells a story of a place where they chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil.  A birdie spins a frisbee, taking a sip of wine as it does so. \n"
}
role: "model"
, parts {
  text: "Missing concepts: None\nCommonsense Feedback: The sentence does not make sense because it is a nonsensical story. Goats cannot leap over fences using poles. Catchers do not tell stories about chopping tomatoes with axes, marching on stage with swords, and batting rollers with pencils.  Birds cannot spin frisbees and take sips of wine.\n\nImpove the sentence using the above feedbacks."
}
role: "user"
, parts {
  text: "A goat leaps over a fence, its hooves hitting the ground with a soft thud. A catcher tells a story of a place where people chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil. A birdie spins a frisbee in the air, watching it soar through the sky. \n"
}
role: "model"
, parts {
  text: "Missing concepts: pole, use, wine, world, step\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks."
}
role: "user"
, parts {
  text: "A goat leaps over a fence, using a pole to step over it, as the world spins around him. A catcher tells a story of a place where people chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil. A birdie spins a frisbee in the air, taking a sip of wine as it does so. \n"
}
role: "model"
, parts {
  text: "Missing concepts: None\nCommonsense Feedback: The sentence does not make sense because a goat cannot use a pole to step over a fence, a catcher cannot tell a story of a place where people chop tomatoes with an axe, march on stage with a sword, and bat a roller with a pencil, and a birdie cannot spin a frisbee in the air while taking a sip of wine."
}
role: "user"
]</pre></details>
</div>
</div>
</section>
</section>
<section id="exp-02-using-gemini-1.5-pro" class="level2">
<h2 class="anchored" data-anchor-id="exp-02-using-gemini-1.5-pro">Exp 02: using <code>gemini-1.5-pro</code></h2>
<section id="generate-the-initital-sentence-1" class="level3">
<h3 class="anchored" data-anchor-id="generate-the-initital-sentence-1">1. generate the initital sentence</h3>
<div id="48d9e277-ff4e-4b0e-89bd-0165dcc948d6" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>init_prompt <span class="op">=</span> init_prompt_template.<span class="bu">format</span>(concepts<span class="op">=</span>concepts)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>utils.display_html(init_prompt, <span class="st">'Show init prompt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<details><summary>Show init prompt</summary><pre>I want you to create a sentence that contains all the specified concepts.

Here are some examples:

Concepts: ['footage', 'motion', 'ruin', 'tilt', 'window']
The sentence is: time lapse footage with tilt up motion of the sun streaking through window of ruin

Concepts: ['cause', 'hate', 'hut', 'local', 'love']
The sentence is: new beach huts on the island have caused some controversy some locals love them others hate them

Concepts: ['call', 'contain', 'dress', 'gown', 'wallpaper']
The sentence is: the wallpaper probably containing a gown and a dinner dress called

Concepts: ['knock', 'leave', 'pew', 'rush', 'seat']
The sentence is: She leaves the confessional and rushes past a pew, knocking a Bible from the seat.

Concepts: ['help', 'moment', 'spend', 'uplift', 'world']
The sentence is: every moment that we spend in higher consciousness helps uplift the consciousness of the whole world

Concepts: ['label', 'pende', 'stamp', 'text', 'write']
The sentence is: abstract stamp or label with the text pending written inside

Concepts: ['create', 'ferry', 'silhouette', 'stream', 'terminal']
The sentence is: light streams through windows at the railroad and ferry terminal creating a beautiful silhouette

Concepts: ['chair', 'couch', 'hang', 'room', 'wall']
The sentence is: A room with a couch, chairs and art hanging on the wall.

Concepts: ['boat', 'building', 'harbour', 'moor', 'quay']
The sentence is: the harbour and port with fishing boats moored and old buildings on the quay

Concepts: ['admirer', 'arrive', 'commander', 'crowd', 'greet']
The sentence is: military commander is greeted by a crowd of admirers as he arrives

Now create a sentence using the following concepts:

Concepts: ['use', 'goat', 'wine', 'frisbee', 'leap', 'pole', 'tell', 'pencil', 'spin', 'birdie', 'catcher', 'fence', 'world', 'step', 'chop', 'sword', 'march', 'stage', 'axe', 'bat', 'place', 'roller', 'tomato']
The sentence is:</pre></details>
</div>
</div>
<div id="3dbbe091-6b6d-4838-8d72-b4a2bc238f6a" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>init_outputs <span class="op">=</span> ask_llm(init_prompt, model_pro)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>sentence <span class="op">=</span> remove_prefix_if_exist(<span class="st">'the sentence is:'</span>, init_outputs)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>sentence</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>'The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board.'</code></pre>
</div>
</div>
</section>
<section id="run-the-refine-loop-1" class="level3">
<h3 class="anchored" data-anchor-id="run-the-refine-loop-1">2. run the refine loop</h3>
<div id="c5f77404-6c10-4f98-a4db-f2ab923ad7d1" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>sentence, history <span class="op">=</span> run_refine_loop(sentence, concepts, model_pro)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>========== DEBUG ==========
Sentence: The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board.
Missing concepts: use, wine, pole, tell, pencil, catcher, step, chop, sword, march, stage, axe, bat, place, roller 
Commonsense Feedback: None
---------------------------
========== DEBUG ==========
Sentence: The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board, as a marching band stepped onto the stage, the drummer using pencils as drumsticks.
Missing concepts: wine, tell, catcher, chop, sword, axe, bat, place, roller 
Commonsense Feedback: None
---------------------------
========== DEBUG ==========
Sentence: The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board as a chef chops it with an axe, a baseball player swinging a bat, missing the ball which is caught by the catcher, and a marching band stepping onto the stage, the drummer using pencils as drumsticks.
Missing concepts: wine, pole, tell, sword, place, roller 
Commonsense Feedback: None
---------------------------
========== DEBUG ==========
Sentence: The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board as a chef chops it with an axe, a baseball player swinging a bat, missing the ball which is caught by the catcher, and a marching band stepping onto the stage, the drummer using pencils as drumsticks. A street performer, balancing a sword on his nose, tells jokes as he juggles wine bottles. A nearby painter, using a roller to paint the scenery, accidentally knocks over a pole.
Missing concepts: 
Commonsense Feedback: None
---------------------------</code></pre>
</div>
</div>
<div id="f3eea55d-a2a8-42b4-9636-52bee4c9c1a1" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sentence</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>'The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board as a chef chops it with an axe, a baseball player swinging a bat, missing the ball which is caught by the catcher, and a marching band stepping onto the stage, the drummer using pencils as drumsticks. A street performer, balancing a sword on his nose, tells jokes as he juggles wine bottles. A nearby painter, using a roller to paint the scenery, accidentally knocks over a pole.'</code></pre>
</div>
</div>
<div id="b90addbb-e34e-45c7-9f5b-9a868993ec5f" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>last_feedback <span class="op">=</span> history[<span class="op">-</span><span class="dv">1</span>].parts[<span class="dv">0</span>].text</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(last_feedback)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Missing concepts: None
Commonsense Feedback: None</code></pre>
</div>
</div>
<div id="70ef0703-73a8-4351-8063-440038a43d3f" class="cell" data-scrolled="true" data-execution_count="75">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>utils.display_html(history, <span class="st">'Show refine history'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<details><summary>Show refine history</summary><pre>[parts {
  text: "We are having multi-turn conversation in order to create a sentence that contains all given concepts. I will provide you with my feedbacks on the sentence regarding missing concepts and whether the sentence makes sense. Your task is to improve the provided sentence based on my feedbacks.\n\nHere are 8 examples of our past conversations:\n\nExample 1:\nUser:\nConcepts: [\'beat\', \'drum\', \'pen\', \'sit\', \'use\']\nSentence: The drum sits on the pen and uses it to beat.\nMissing concepts: None\nCommonsense Feedback: The sentence does not make sense because a drum cannot sit on a pen and use it to beat.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The drummer uses the drum to beat.\nUser:\nMissing concepts: sit, pen\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The drummer sits behind the drum and uses it to beat the pen.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 2:\nUser:\nConcepts: [\'chair\', \'clipper\', \'cut\', \'hair\', \'sit\']\nSentence: A couch shaped girl sitting on the chair with her hair clipper.\nMissing concepts: cut\nCommonsense Feedback: The sentence does not make sense because a couch is not a shape and a hair clipper is not an item of clothing.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A girl on the chair with her hair clipper and cutting her hair.\nUser:\nMissing concepts: sit\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A girl sitting on the chair with a hair clipper, cutting her hair up.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 3:\nUser:\nConcepts: [\'grass\', \'hose\', \'spray\', \'stand\', \'water\']\nSentence: The grass is standing tall and a hose is spraying it with spray.\nMissing concepts: water\nCommonsense Feedback: The sentence does not make sense because it is not clear what \'spray\' is referring to, and grass does not have the ability to stand upright like a human or animal.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The hose is spraying water onto the grass that is standing like a person.\nUser:\nMissing concepts: None\nCommonsense Feedback: The sentence does not make sense because grass cannot stand upright like a human or animal.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A person is standing on the grass, holding a hose that is spraying water onto the grass.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 4:\nUser:\nConcepts: [\'front\', \'gong\', \'hit\', \'mallet\', \'stand\']\nSentence: A mallet is standing in front of a gong.\nMissing concepts: hit\nCommonsense Feedback: The sentence does not make sense because a mallet cannot stand in the front of a gong.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A musician stands in front of a gong with a mallet.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The musician stands in front of the gong and hits it with a mallet.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 5:\nUser:\nConcepts: [\'ball\', \'dunk\', \'hoop\', \'jump\', \'run\']\nSentence: The ball runs to the hoop and dunks it.\nMissing concepts: jump\nCommonsense Feedback: The sentence does not make sense because a ball cannot run and dunk.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The ball jumps to the hoop and dunks it.\nUser:\nMissing concepts: run\nCommonsense Feedback: The sentence does not make sense because a ball cannot jump.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A basketball player runs up to the hoop and jumps off of the ball to dunk it.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 6:\nUser:\nConcepts: [\'card\', \'chip\', \'deal\', \'dealer\', \'table\']\nSentence: A dealer offers a card to a group of people at a table.\nMissing concepts: chip, deal\nCommonsense Feedback: The sentence does not make sense because a chip cannot deal a card to a dealer.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The dealer deals a card to a group of people.\nUser:\nMissing concepts: chip\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The dealer deals a card to a group of people around the table with a chip at the table.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 7:\nUser:\nConcepts: [\'clean\', \'climb\', \'gutter\', \'house\', \'ladder\']\nSentence: The house is clean and a ladder is trying to climb.\nMissing concepts: climb\nCommonsense Feedback: The sentence does not make sense because ladders cannot climb by themselves.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A person is cleaning the gutter of the house by climbing onto the roof with a ladder made of glass.\nUser:\nMissing concepts: None\nCommonsense Feedback: The sentence does not make sense because ladders are not made of glass, and using a glass ladder would be dangerous and impractical.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: A person is cleaning the gutter of the house by using a ladder to climb onto the roof and brushing away the dirt.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nExample 8:\nUser:\nConcepts: [\'animal\', \'catch\', \'horse\', \'lasso\', \'ride\']\nSentence: The horse catches the lasso and rides on it.\nMissing concepts: animal\nCommonsense Feedback: The sentence does not make sense because a horse cannot catch a lasso and ride on it.\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The cowboy catches a horse with a lasso and rides on it.\nUser:\nMissing concepts: animal\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks.\nAssistant:\nSentence: The cowboy catches the horse with a lasso and rides it.\nUser:\nMissing concepts: None\nCommonsense Feedback: None\n\nNow let\'s start a new conversation so that you can improve a constructed sentence based on my feedbacks.\n\nConcepts: [\'use\', \'goat\', \'wine\', \'frisbee\', \'leap\', \'pole\', \'tell\', \'pencil\', \'spin\', \'birdie\', \'catcher\', \'fence\', \'world\', \'step\', \'chop\', \'sword\', \'march\', \'stage\', \'axe\', \'bat\', \'place\', \'roller\', \'tomato\']\nSentence: The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board.\nMissing concepts: sword, roller, pencil, stage, chop, place, pole, catcher, use, wine, march, step, axe, bat, tell\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks."
}
role: "user"
, parts {
  text: "The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board, as a marching band stepped onto the stage, the drummer using pencils as drumsticks. \n"
}
role: "model"
, parts {
  text: "Missing concepts: sword, roller, chop, place, wine, catcher, axe, bat, tell\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks."
}
role: "user"
, parts {
  text: "The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board as a chef chops it with an axe, a baseball player swinging a bat, missing the ball which is caught by the catcher, and a marching band stepping onto the stage, the drummer using pencils as drumsticks.  \n"
}
role: "model"
, parts {
  text: "Missing concepts: sword, roller, place, pole, wine, tell\nCommonsense Feedback: None\n\nImpove the sentence using the above feedbacks."
}
role: "user"
, parts {
  text: "The goat, perched atop the fence post, watched the world go by: a frisbee spinning through the air, a birdie leaping over a badminton net, a tomato rolling off a chopping board as a chef chops it with an axe, a baseball player swinging a bat, missing the ball which is caught by the catcher, and a marching band stepping onto the stage, the drummer using pencils as drumsticks. A street performer, balancing a sword on his nose, tells jokes as he juggles wine bottles. A nearby painter, using a roller to paint the scenery, accidentally knocks over a pole. \n"
}
role: "model"
, parts {
  text: "Missing concepts: None\nCommonsense Feedback: None"
}
role: "user"
]</pre></details>
</div>
</div>



</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0" role="list">
<div id="ref-madaan2023selfrefine" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">A. Madaan <em>et al.</em>, <span>“Self-refine: Iterative refinement with self-feedback.”</span> 2023. Available: <a href="https://arxiv.org/abs/2303.17651">https://arxiv.org/abs/2303.17651</a></div>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/liminma\.github\.io\/machine-learning-lab");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>